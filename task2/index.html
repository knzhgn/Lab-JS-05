<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lab 5.2: Dynamic Imports Demo</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 40px auto; padding: 20px; }
    button { margin: 8px 4px; padding: 8px 16px; cursor: pointer; }
    #stats-output, #export-output { background: #f5f5f5; padding: 12px; margin-top: 10px; border-radius: 4px; white-space: pre; }
    #lazy-section { margin-top: 600px; padding: 20px; border: 2px dashed #ccc; }
  </style>
</head>
<body>
  <h1>Todo App — Dynamic Imports Demo</h1>

  <h2>Import on Interaction</h2>
  <p>Click the button to dynamically load the statistics module:</p>
  <button id="statsBtn">Show Statistics (loads module)</button>
  <div id="stats-output">Stats will appear here after module loads...</div>

  <hr>

  <h2>Import on Visibility</h2>
  <p>Scroll down to see the export section — it will load its module when visible.</p>

  <!-- This element is far down the page — triggers Import on Visibility -->
  <div id="lazy-section">
    <h3>Export Section (loaded by IntersectionObserver)</h3>
    <div id="export-output">Scroll here to trigger dynamic import...</div>
  </div>

  <!-- type="module" required for ES modules in browser (Ch. 5) -->
  <script type="module">
    // Static imports — always loaded
    import { generateId, formatDate } from './modules/utils.mjs';
    import * as Constants from './modules/constants.mjs';

    // Simple in-memory todo store for demo
    const todos = [
      { id: generateId(), text: 'Buy groceries', priority: 'high', done: true, createdAt: formatDate() },
      { id: generateId(), text: 'Read JS book', priority: 'medium', done: false, createdAt: formatDate() },
      { id: generateId(), text: 'Go for a walk', priority: 'low', done: false, createdAt: formatDate() },
    ];

    // ── Import on Interaction ────────────────────────────────────────────
    document.getElementById('statsBtn').addEventListener('click', async () => {
      try {
        // Module is downloaded ONLY when user clicks — Ch. 5, "Import on Interaction"
        const { generateStats, renderStats } = await import('./modules/advanced_feature.mjs');
        const store = { getAll: () => todos, getDone: () => todos.filter(t => t.done), getActive: () => todos.filter(t => !t.done) };
        document.getElementById('stats-output').textContent = renderStats(generateStats(store));
      } catch (err) {
        document.getElementById('stats-output').textContent = `Error: ${err.message}`;
      }
    });

    // ── Import on Visibility ─────────────────────────────────────────────
    // IntersectionObserver fires when #lazy-section scrolls into viewport
    const observer = new IntersectionObserver(async (entries) => {
      for (const entry of entries) {
        if (entry.isIntersecting) {
          observer.unobserve(entry.target); // Load once only
          try {
            // Module is downloaded ONLY when element becomes visible — Ch. 5, "Import on Visibility"
            const { exportToCSV } = await import('./modules/lazy_component.mjs');
            document.getElementById('export-output').textContent =
              'Module loaded!\n\n' + exportToCSV(todos);
          } catch (err) {
            document.getElementById('export-output').textContent = `Error: ${err.message}`;
          }
        }
      }
    }, { threshold: 0.1 });

    observer.observe(document.getElementById('lazy-section'));
  </script>
</body>
</html>
